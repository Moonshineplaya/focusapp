<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clean Days — Focus Shield</title>
<meta name="description" content="Count days clean and open a camera shield with Bible quotes when tempted" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#071025;
    --bg2:#071c2f;
    --card:#071430;
    --glass: rgba(255,255,255,0.04);
    --accent:#7bd389;
    --accent2:#7bc1ff;
    --muted:#9fb0c2;
    --white: #e8f6ff;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--white);background:linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 100%);}
  .wrap{max-width:720px;margin:28px auto;padding:20px;}
  header{display:flex;align-items:center;gap:14px}
  .logo{width:66px;height:66px;border-radius:14px;background:linear-gradient(135deg,#0b3a4b,#05293a);display:flex;align-items:center;justify-content:center;color:var(--white);font-weight:800;font-size:20px;box-shadow:0 10px 30px rgba(6,10,20,0.6)}
  h1{font-size:22px;margin:0}
  .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:20px;margin-top:18px;box-shadow:0 14px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  .top-row{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
  .big{font-weight:800;font-size:56px;line-height:1;color:var(--accent);text-align:center;font-variant-numeric:tabular-nums}
  .small-muted{color:var(--muted);font-size:13px;text-align:center}
  .last-slip{font-weight:700;color:var(--accent2)}
  .clock-box{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;text-align:center}
  .clock-line{font-weight:700;font-size:18px}
  .controls{display:flex;gap:12px;justify-content:center;margin-top:18px;flex-wrap:wrap}
  button{background:linear-gradient(180deg,#144a5f,#0f3b4c);border:1px solid rgba(255,255,255,0.04);color:var(--white);padding:12px 16px;border-radius:12px;font-weight:700;min-width:140px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);min-width:120px}
  button.danger{background:linear-gradient(180deg,#ff6b6b,#ff4b4b);border:none}
  footer{color:var(--muted);text-align:center;font-size:13px;margin-top:18px}
  .hint{font-size:13px;color:var(--muted);text-align:center;margin-top:10px}

  /* full screen shield */
  .shield{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;z-index:9999}
  .shade{position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.08), rgba(0,0,0,0.45));backdrop-filter: blur(6px);pointer-events:none}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:black}
  .overlay{position:relative;z-index:2;width:100%;display:flex;flex-direction:column;align-items:center;padding:18px;pointer-events:none}
  .shield-top{display:flex;justify-content:space-between;align-items:center;width:100%;padding:12px 18px;color:var(--muted);pointer-events:auto}
  .pill{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;font-weight:700;color:var(--white)}
  .quote-wrap{width:100%;max-width:980px;padding:20px;display:flex;align-items:center;justify-content:center}
  .quote{pointer-events:auto;background:linear-gradient(180deg, rgba(8,8,8,0.25), rgba(8,8,8,0.45));backdrop-filter: blur(8px);padding:20px;border-radius:14px;color:#fff;text-align:center;font-size:20px;font-weight:700;line-height:1.25;max-width:900px}
  .shield-controls{display:flex;gap:10px;margin-top:22px;pointer-events:auto}
  .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;color:var(--muted);font-weight:700}
  .close-big{background:linear-gradient(180deg,#ff7b7b,#ff5656);border:none;padding:10px 14px;border-radius:12px;color:white;font-weight:800}

  .hidden{display:none}

  /* shaking animation for text */
  @keyframes shake {
    0% { transform: translate(0px, 0px); }
    20% { transform: translate(-2px, 2px); }
    40% { transform: translate(2px, -2px); }
    60% { transform: translate(-2px, 2px); }
    80% { transform: translate(2px, -2px); }
    100% { transform: translate(0px, 0px); }
  }

  .shake {
    animation: shake 0.1s infinite;
  }

  /* red border around camera */
  .cam-alert {
    box-shadow: 0 0 20px 6px red inset;
    border-radius: 4px;
  }

  @media (max-width:520px){
    .big{font-size:40px}
    .quote{font-size:18px;padding:16px}
    .controls{gap:8px}
    button{min-width:110px;padding:10px 12px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">FD</div>
    <div>
      <h1>Clean Days</h1>
      <div class="sub">Count the time since your last slip and shield yourself when tempted</div>
    </div>
  </header>

  <div class="card" id="mainCard">
    <div class="top-row">
      <div style="flex:1">
        <div style="text-align:center">
          <div class="big" id="daysCount">0</div>
          <div class="small-muted">days clean</div>
        </div>
      </div>

      <div style="width:260px">
        <div class="clock-box">
          <div class="small-muted">Time since last slip</div>
          <div class="clock-line" id="elapsedClock">0d 00:00:00</div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">Last slip: <span id="lastSlipText" class="last-slip"></span></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="startShieldBtn" aria-label="Open Focus Shield">Start Shield</button>
      <button id="slipBtn" class="ghost" aria-label="Record I slipped">I slipped</button>
      <button id="resetAll" class="ghost">Reset to today</button>
    </div>

    <div class="hint">
      Tip press Start Shield when you feel tempted allow camera when asked and use the Read button to listen
    </div>
  </div>

  <footer>
    Works in Safari on iPhone — add to Home Screen for app feel
  </footer>
</div>

<!-- Shield full screen -->
<div id="shield" class="shield hidden" role="dialog" aria-modal="true">
  <video id="cam" autoplay playsinline muted></video>
  <div class="shade"></div>

  <div class="overlay">
    <div class="shield-top" style="max-width:980px">
      <div class="pill" id="quoteCounter">1 / 5</div>
      <div style="display:flex;gap:8px">
        <button id="prevQuote" class="small-btn">Prev</button>
        <button id="nextQuote" class="small-btn">Next</button>
        <button id="closeShield" class="close-big">Close</button>
      </div>
    </div>

    <div class="quote-wrap">
      <div class="quote" id="quoteText">Loading...</div>
    </div>

    <div class="shield-controls" style="justify-content:center">
      <button id="speakBtn" class="small-btn">Read</button>
      <button id="changeCam" class="small-btn">Switch Cam</button>
    </div>
  </div>
</div>

<script>
(() => {
  const QUOTES = [
    "Flee from sexual immorality 1 Corinthians 6:18",
    "Anyone who looks at a woman lustfully has committed adultery in his heart Matthew 5:28",
    "Blessed are the pure in heart for they will see God Matthew 5:8",
    "Keep your heart with all vigilance for from it flow the springs of life Proverbs 4:23",
    "I can do all things through him who strengthens me Philippians 4:13"
  ];

  const KEY = 'focus.lastSlip.v1';

  const daysCountEl = document.getElementById('daysCount');
  const lastSlipTextEl = document.getElementById('lastSlipText');
  const startShieldBtn = document.getElementById('startShieldBtn');
  const slipBtn = document.getElementById('slipBtn');
  const resetAllBtn = document.getElementById('resetAll');
  const shield = document.getElementById('shield');
  const cam = document.getElementById('cam');
  const quoteText = document.getElementById('quoteText');
  const prevQuote = document.getElementById('prevQuote');
  const nextQuote = document.getElementById('nextQuote');
  const closeShield = document.getElementById('closeShield');
  const quoteCounter = document.getElementById('quoteCounter');
  const speakBtn = document.getElementById('speakBtn');
  const changeCam = document.getElementById('changeCam');
  const elapsedClock = document.getElementById('elapsedClock');

  let quoteIndex = 0;
  let cycleTimer = null;
  let lastSlip = loadLastSlip();
  let stream = null;
  let usingFacingMode = 'user';
  let speechUtter = null;
  let clockTimer = null;
  let voicesReady = false;
  let preferredVoice = null;

  updateUI();
  showQuote();

  function startClock() {
    stopClock();
    clockTimer = setInterval(updateClock,1000);
  }
  function stopClock() {
    if(clockTimer){clearInterval(clockTimer);clockTimer=null;}
  }
  function updateClock(){
    const d = daysSince(lastSlip);
    daysCountEl.textContent = String(d.days);
    elapsedClock.textContent = `${d.days}d ${pad(d.hours)}:${pad(d.minutes)}:${pad(d.seconds)}`;
  }
  function pad(n){return String(n).padStart(2,'0');}
  function daysSince(date){
    const now = new Date();
    const ms = now - new Date(date);
    let totalSec = Math.floor(ms/1000);
    const days = Math.floor(totalSec/(3600*24));
    totalSec -= days*3600*24;
    const hours = Math.floor(totalSec/3600);
    totalSec -= hours*3600;
    const minutes = Math.floor(totalSec/60);
    const seconds = totalSec-minutes*60;
    return {days,hours,minutes,seconds};
  }
  function loadLastSlip(){
    const raw = localStorage.getItem(KEY);
    if(!raw){
      const d = new Date();
      localStorage.setItem(KEY,d.toISOString());
      return new Date(d);
    }
    return new Date(raw);
  }
  function saveLastSlip(d){
    localStorage.setItem(KEY,d.toISOString());
    lastSlip = new Date(d);
    updateUI();
  }
  function updateUI(){
    lastSlipTextEl.textContent = lastSlip.toLocaleString();
    updateClock();
    startClock();
  }

  startShieldBtn.addEventListener('click',openShield);
  slipBtn.addEventListener('click',()=>{if(!confirm('Record slip today and reset counter?')) return; saveLastSlip(new Date());});
  resetAllBtn.addEventListener('click',()=>{if(!confirm('Reset the counter to today?')) return; saveLastSlip(new Date());});
  prevQuote.addEventListener('click',previousQuote);
  nextQuote.addEventListener('click',nextQuoteFn);
  closeShield.addEventListener('click',closeShieldFn);
  changeCam.addEventListener('click',switchCamera);

  function showQuote(){
    quoteText.textContent = QUOTES[quoteIndex];
    quoteCounter.textContent = (quoteIndex+1)+' / '+QUOTES.length;
  }
  function nextQuoteFn(){quoteIndex=(quoteIndex+1)%QUOTES.length;showQuote();}
  function previousQuote(){quoteIndex=(quoteIndex-1+QUOTES.length)%QUOTES.length;showQuote();}

  async function openShield(){
    shield.classList.remove('hidden');
    quoteIndex=0;showQuote();
    startCycle();
    quoteText.classList.add('shake');
    cam.classList.add('cam-alert');
    await startCamera();
  }

  function closeShieldFn(){
    shield.classList.add('hidden');
    stopCycle();stopCamera();stopSpeak();
    quoteText.classList.remove('shake');
    cam.classList.remove('cam-alert');
  }

  async function startCamera(){
    try{
      stopCamera();
      stream = await navigator.mediaDevices.getUserMedia({audio:false,video:{facingMode:usingFacingMode}});
      cam.srcObject=stream; await cam.play().catch(()=>{});
    }catch(err){console.error(err);}
  }
  function stopCamera(){try{if(stream){stream.getTracks().forEach(t=>{try{t.stop();}catch(e){}});}}catch(e){}finally{stream=null;try{cam.pause();cam.srcObject=null;}catch(e){}}}
  async function switchCamera(){usingFacingMode=(usingFacingMode==='user')?'environment':'user'; await startCamera();}
  function startCycle(){stopCycle();cycleTimer=setInterval(nextQuoteFn,7000);}
  function stopCycle(){if(cycleTimer){clearInterval(cycleTimer);cycleTimer=null;}}

})();
</script>
</body>
</html>
